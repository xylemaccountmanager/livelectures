<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vibruchur</title>

<style>
body{
  font-family: "Comic Sans MS", Arial, sans-serif;
  text-align:center;
  padding:30px;
  background:#ffd6e7;
  color:#6b4a5a;
}

h1{
  font-size:42px;
  margin-bottom:10px;
}

.subtitle{
  opacity:0.7;
  margin-bottom:25px;
}

button{
  padding:18px 34px;
  font-size:18px;
  margin:10px;
  border-radius:20px;
  border:none;
  background:#ffb3d1;
  color:#6b4a5a;
  box-shadow:0 6px 0 #f48fb1;
}

button:active{
  transform:translateY(3px);
  box-shadow:0 3px 0 #f48fb1;
}

#vibrateBtn{
  display:block;
  margin:20px auto;
  background:#ff8fb8;
  font-weight:bold;
  opacity:0.5;
}

.card{
  background:#ffe4ef;
  padding:20px;
  border-radius:20px;
  margin-top:20px;
}

#status{
  margin-top:10px;
  font-weight:bold;
}

#logBox{
  margin-top:25px;
  background:#fff0f6;
  padding:12px;
  border-radius:15px;
  height:170px;
  overflow:auto;
  text-align:left;
  font-size:12px;
  border:2px dashed #ffb3d1;
}
</style>
</head>

<body>

<h1>Vibruchu</h1>
<div class="subtitle">live vibration sync</div>

<div id="roleSelect" class="card">
  <button onclick="setRole('sender')">Sender</button>
  <button onclick="setRole('receiver')">Receiver</button>
</div>

<button id="vibrateBtn" disabled>PRESS AND HOLD</button>

<div id="status">Choose your role…</div>

<div id="logBox"></div>

<script>
// ===== VIBRUCHU LOGIC =====
let ws;
let role;
let isHolding = false;

const SIGNAL_SERVER = "wss://vibr-p581.onrender.com";
const SENDER_ID = "sender";
const RECEIVER_ID = "receiver";

function log(msg){
  console.log(msg);
  const box = document.getElementById("logBox");
  box.innerHTML += "• " + msg + "<br>";
  box.scrollTop = box.scrollHeight;
}

function setStatus(text){
  document.getElementById("v-status").innerText = text;
  log(text);
}

function setRole(r){
  role = r;
  document.getElementById("roleSelect").style.display = "none";
  setStatus("Connecting to server…");
  connectWebSocket();
}

function connectWebSocket(){
  try { ws = new WebSocket(SIGNAL_SERVER); }
  catch(e){ setStatus("WebSocket failed"); return; }

  ws.onopen = () => {
    // Register with the server using this role as userId
    ws.send(JSON.stringify({ type: "register", userId: role }));
    setStatus("Connected. Waiting for peer…");

    if(role === "sender") setupSender();
    else setupReceiver();
  };

  ws.onerror = () => { setStatus("Cannot reach signal server"); };

  ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    log("Got: " + data.type);

    if(data.type === "vibrate"){
      // Receiver gets vibration commands directly (no WebRTC needed)
      if(!navigator.vibrate){ log("Vibration not supported"); return; }
      navigator.vibrate(data.pattern || [200, 100]);
    }

    if(data.type === "stop"){
      if(navigator.vibrate) navigator.vibrate(0);
    }
  };
}

function setupSender(){
  const btn = document.getElementById("vibrateBtn");
  btn.disabled = false;
  btn.style.opacity = "1";
  setStatus("Ready. Hold button to vibrate receiver.");

  function press(){
    if(isHolding) return;
    isHolding = true;
    if(navigator.vibrate) navigator.vibrate([200, 100]);
    // Send vibrate command to receiver via server
    ws.send(JSON.stringify({
      type: "vibrate",
      to: RECEIVER_ID,
      pattern: [200, 100]
    }));
  }

  function release(){
    if(!isHolding) return;
    isHolding = false;
    if(navigator.vibrate) navigator.vibrate(0);
    ws.send(JSON.stringify({
      type: "stop",
      to: RECEIVER_ID
    }));
  }

  btn.onmousedown = press;
  btn.onmouseup = release;
  btn.onmouseleave = release;
  btn.ontouchstart = (e) => { e.preventDefault(); press(); };
  btn.ontouchend = release;
  btn.ontouchcancel = release;
}

function setupReceiver(){
  setStatus("Waiting for sender to press…");
  // Receiver just listens — ws.onmessage handles everything
}
</script>

</body>
</html>
