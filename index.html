<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0d1117">
<title>Xylem Extras ‚Äì Live Lectures</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d1117;--card:#161b22;--border:#21262d;--accent:#2ecc71;--text:#e6edf3;--muted:#7d8590;--red:#e74c3c;--blue:#3498db;--yellow:#f1c40f;--safe-bottom:env(safe-area-inset-bottom,0px);}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
nav{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--border);background:#0d1117f0;position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
.logo{font-family:'Sora',sans-serif;font-size:20px;font-weight:700;color:var(--accent);}
.logo span{color:var(--text);}
.nav-right{display:flex;align-items:center;gap:10px;}
.live-badge{background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:3px 7px;border-radius:4px;letter-spacing:1px;animation:pa 2s infinite;cursor:pointer;user-select:none;}
@keyframes pa{0%,100%{opacity:1;}50%{opacity:0.5;}}
.nav-links{list-style:none;display:flex;gap:22px;}
.nav-links a{color:var(--muted);text-decoration:none;font-size:14px;}
@media(max-width:600px){.nav-links{display:none;}}
.hero{padding:24px 16px 12px;}
.hero h1{font-family:'Sora',sans-serif;font-size:clamp(22px,6vw,40px);font-weight:700;line-height:1.2;margin-bottom:8px;}
.hero h1 em{color:var(--accent);font-style:normal;}
.hero p{color:var(--muted);font-size:14px;line-height:1.6;}
.tabs{display:flex;gap:8px;padding:14px 16px 0;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700;border:1.5px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Nunito',sans-serif;transition:all 0.2s;}
.tab.active{border-color:var(--accent);color:var(--accent);background:#2ecc7115;}
.tab.physics.active{border-color:var(--blue);color:var(--blue);background:#3498db15;}
.tab.chemistry.active{border-color:var(--yellow);color:var(--yellow);background:#f1c40f15;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;padding:14px 16px;}
@media(max-width:380px){.grid{grid-template-columns:1fr;}}
.lecture-card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:transform 0.15s;}
.lecture-card:active{transform:scale(0.97);}
.thumb{width:100%;height:148px;display:flex;align-items:center;justify-content:center;font-size:46px;position:relative;}
.thumb.physics-bg{background:linear-gradient(135deg,#0d2137,#1a3a5c);}
.thumb.chemistry-bg{background:linear-gradient(135deg,#1a1a00,#3a3a00);}
.thumb.maths-bg{background:linear-gradient(135deg,#0d2214,#1a4a2a);}
.live-dot{position:absolute;top:9px;left:9px;background:var(--red);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;letter-spacing:1px;}
.viewer-count{position:absolute;bottom:9px;right:9px;background:#00000090;color:#fff;font-size:11px;padding:2px 8px;border-radius:4px;}
.card-body{padding:13px;}
.card-body h3{font-family:'Sora',sans-serif;font-size:14px;font-weight:600;margin-bottom:4px;line-height:1.4;}
.card-body p{color:var(--muted);font-size:12px;line-height:1.55;}
.subject-tag{display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;margin-bottom:7px;letter-spacing:0.5px;}
.tag-physics{background:#3498db20;color:var(--blue);}
.tag-chemistry{background:#f1c40f20;color:var(--yellow);}
.tag-maths{background:#2ecc7120;color:var(--accent);}
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#161b22f0;border-top:1px solid var(--border);backdrop-filter:blur(12px);padding:6px 0 calc(6px + var(--safe-bottom));z-index:99;}
.bottom-nav-inner{display:flex;justify-content:space-around;}
.bnav-item{display:flex;flex-direction:column;align-items:center;gap:2px;color:var(--muted);font-size:11px;font-weight:700;background:none;border:none;cursor:pointer;padding:4px 10px;font-family:'Nunito',sans-serif;}
.bnav-item span{font-size:20px;}
.bnav-item.active{color:var(--accent);}
@media(max-width:600px){.bottom-nav{display:block;}body{padding-bottom:calc(62px + var(--safe-bottom));}}
.modal{display:none;position:fixed;inset:0;background:#000c;z-index:999;align-items:flex-end;justify-content:center;}
.modal.open{display:flex;}
.player{background:var(--card);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:700px;}
.drag-handle{width:36px;height:4px;background:#444;border-radius:2px;margin:10px auto 0;}
.player-screen{width:100%;height:min(52vw,340px);background:#000;display:flex;align-items:center;justify-content:center;font-size:clamp(38px,10vw,68px);flex-direction:column;gap:10px;position:relative;}
.player-screen p{font-size:13px;color:var(--muted);font-family:'Nunito',sans-serif;}
.progress-bar{width:88%;height:3px;background:#333;border-radius:2px;position:absolute;bottom:14px;}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;width:37%;animation:prog 20s linear infinite;}
@keyframes prog{0%{width:37%;}100%{width:99%;}}
.player-info{padding:12px 16px 16px;display:flex;justify-content:space-between;align-items:center;}
.player-info h2{font-family:'Sora',sans-serif;font-size:14px;}
.close-btn{background:var(--border);border:none;color:var(--text);font-size:13px;padding:7px 14px;border-radius:10px;cursor:pointer;font-family:'Nunito',sans-serif;}
/* secret trigger on LIVE badge ‚Äî no extra CSS needed */
#vibruchu-panel{display:none;position:fixed;inset:0;z-index:10000;background:linear-gradient(160deg,#ffe4f0,#ffd6e7,#ffc8e0);font-family:'Nunito',sans-serif;color:#6b4a5a;flex-direction:column;align-items:center;justify-content:center;padding:20px 20px calc(20px + var(--safe-bottom));gap:16px;overflow-y:auto;}
#vibruchu-panel.open{display:flex;}
.v-back{position:absolute;top:16px;left:16px;background:#ffb3d155;border:none;color:#6b4a5a;font-size:13px;font-weight:700;padding:8px 14px;border-radius:12px;cursor:pointer;font-family:'Nunito',sans-serif;}
.v-logo{font-family:'Sora',sans-serif;font-size:clamp(30px,8vw,46px);font-weight:700;color:#c0396b;letter-spacing:-1px;}
.v-sub{font-size:13px;opacity:0.65;margin-top:-10px;}
.v-status-bar{display:flex;align-items:center;gap:8px;background:#fff5f9;padding:10px 18px;border-radius:14px;font-size:13px;font-weight:600;border:1.5px solid #ffb3d1;min-width:200px;justify-content:center;}
#v-dot{width:10px;height:10px;border-radius:50%;background:#ddd;flex-shrink:0;transition:background 0.3s;}
#v-dot.waiting{background:var(--yellow);animation:pa 1s infinite;}
#v-dot.connected{background:#2ecc71;box-shadow:0 0 8px #2ecc71aa;}
#v-dot.error{background:var(--red);}
.v-role-card{background:#fff5f9;border:2px dashed #ffb3d1;border-radius:20px;padding:22px;text-align:center;width:min(320px,92vw);}
.v-role-card p{font-size:14px;margin-bottom:14px;font-weight:600;opacity:0.8;}
.v-role-btns{display:flex;gap:10px;justify-content:center;}
.v-btn{padding:13px 24px;font-size:16px;font-weight:700;border-radius:16px;border:none;background:#ffb3d1;color:#6b4a5a;box-shadow:0 5px 0 #f48fb1;cursor:pointer;font-family:'Nunito',sans-serif;min-width:110px;transition:transform 0.08s,box-shadow 0.08s;}
.v-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #f48fb1;}
#vibrateBtn{width:min(220px,68vw);height:min(220px,68vw);border-radius:50%;border:none;background:radial-gradient(circle at 38% 35%,#ff8fb8,#f06090);color:#fff;font-family:'Sora',sans-serif;font-size:clamp(13px,4vw,17px);font-weight:700;letter-spacing:1px;box-shadow:0 8px 0 #c0396b,0 0 40px #ff8fb855;cursor:pointer;opacity:0.38;pointer-events:none;transition:opacity 0.3s,transform 0.08s,box-shadow 0.08s;display:none;flex-direction:column;align-items:center;justify-content:center;gap:5px;text-align:center;line-height:1.3;}
#vibrateBtn .btn-icon{font-size:clamp(26px,8vw,36px);}
#vibrateBtn.ready{opacity:1;pointer-events:all;animation:float 3s ease-in-out infinite;}
#vibrateBtn.ready:active{transform:scale(0.92) translateY(4px);box-shadow:0 4px 0 #c0396b,0 0 60px #ff8fb8bb;animation:none;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-7px);}}
.v-receiver-waiting{display:none;flex-direction:column;align-items:center;gap:10px;}
.v-receiver-waiting.show{display:flex;}
.heartbeat{font-size:clamp(52px,15vw,72px);animation:hb 1.3s ease-in-out infinite;}
@keyframes hb{0%,100%{transform:scale(1);}14%{transform:scale(1.28);}28%{transform:scale(1);}42%{transform:scale(1.14);}}
.v-receiver-waiting p{font-size:14px;opacity:0.7;font-weight:600;}
#logBox{background:#fff5f9;padding:10px 12px;border-radius:14px;height:82px;overflow:auto;text-align:left;font-size:11px;border:1.5px dashed #ffb3d1;width:min(320px,92vw);color:#9b6a7a;}

/* role tag shown after pairing */
.v-role-tag{display:inline-block;background:#ffb3d1;color:#6b4a5a;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;letter-spacing:0.5px;margin-bottom:2px;}

/* controls card (sliders + wave + continuous) */
.v-controls{background:#fff5f9;border:1.5px solid #ffb3d1;border-radius:20px;padding:16px 18px;width:min(320px,92vw);display:flex;flex-direction:column;gap:14px;}
.v-ctrl-row{display:flex;flex-direction:column;gap:5px;}
.v-ctrl-label{display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:700;opacity:0.8;}
.v-ctrl-label span{font-size:13px;font-weight:800;color:#c0396b;}
input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:linear-gradient(to right,#f06090 0%,#f06090 var(--pct,50%),#ffd6e7 var(--pct,50%),#ffd6e7 100%);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#c0396b;box-shadow:0 2px 6px #c0396b66;cursor:pointer;}
input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#c0396b;border:none;cursor:pointer;}

/* bottom row: continuous toggle + wave btn */
.v-action-row{display:flex;gap:10px;align-items:center;justify-content:space-between;}

/* continuous toggle */
.v-toggle-wrap{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;opacity:0.85;cursor:pointer;flex:1;}
.v-toggle{position:relative;width:44px;height:24px;flex-shrink:0;}
.v-toggle input{opacity:0;width:0;height:0;}
.v-toggle-track{position:absolute;inset:0;background:#ffd6e7;border-radius:12px;border:1.5px solid #ffb3d1;transition:background 0.2s;}
.v-toggle input:checked+.v-toggle-track{background:#f06090;border-color:#c0396b;}
.v-toggle-thumb{position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;box-shadow:0 1px 4px #0002;transition:transform 0.2s;}
.v-toggle input:checked~.v-toggle-thumb{transform:translateX(20px);}

/* wave button */
.v-wave-btn{background:#ffb3d1;border:none;color:#6b4a5a;font-size:22px;width:44px;height:44px;border-radius:14px;cursor:pointer;box-shadow:0 4px 0 #f48fb1;transition:transform 0.08s,box-shadow 0.08s;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.v-wave-btn:active{transform:translateY(3px);box-shadow:0 1px 0 #f48fb1;}

/* wave toast popup */
#waveToast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:10001;font-size:clamp(60px,20vw,100px);pointer-events:none;transition:transform 0.15s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s;opacity:0;}
#waveToast.show{transform:translate(-50%,-50%) scale(1);opacity:1;}
#waveToast.hide{transform:translate(-50%,-50%) scale(0.5);opacity:0;}
#waveFrom{position:fixed;top:calc(50% + clamp(46px,13vw,66px));left:50%;transform:translateX(-50%);z-index:10001;font-size:13px;font-weight:700;color:#c0396b;background:#fff5f9;padding:4px 12px;border-radius:20px;border:1.5px solid #ffb3d1;pointer-events:none;opacity:0;transition:opacity 0.3s;}
#waveFrom.show{opacity:1;}
</style>
</head>
<body>
<nav>
  <div class="logo">Xylem<span>Extras</span></div>
  <div class="nav-right">
    <ul class="nav-links"><li><a href="#">Home</a></li><li><a href="#">Schedule</a></li><li><a href="#">Notes</a></li><li><a href="#">Tests</a></li></ul>
    <span class="live-badge">‚óè LIVE</span>
  </div>
</nav>
<div class="hero">
  <h1>Learn from the<br><em>best educators,</em> live.</h1>
  <p>Stream Physics, Chemistry and Maths lectures in real-time.</p>
</div>
<div class="tabs">
  <button class="tab active" onclick="filterCards('all',this)">All</button>
  <button class="tab physics" onclick="filterCards('physics',this)">‚ö° Physics</button>
  <button class="tab chemistry" onclick="filterCards('chemistry',this)">üß™ Chemistry</button>
  <button class="tab maths" onclick="filterCards('maths',this)">‚àë Maths</button>
</div>
<div class="grid" id="lectureGrid">
  <div class="lecture-card" data-subject="physics" onclick="openPlayer('Electromagnetic Induction','‚ö°','physics-bg')">
    <div class="thumb physics-bg">‚ö°<div class="live-dot">LIVE</div><div class="viewer-count">üëÅ 2,341</div></div>
    <div class="card-body"><div class="subject-tag tag-physics">PHYSICS</div><h3>Electromagnetic Induction ‚Äì Class XII</h3><p>Faraday's law, Lenz's law and self-inductance with derivations.</p></div>
  </div>
  <div class="lecture-card" data-subject="chemistry" onclick="openPlayer('Chemical Bonding','üß™','chemistry-bg')">
    <div class="thumb chemistry-bg">üß™<div class="live-dot">LIVE</div><div class="viewer-count">üëÅ 1,879</div></div>
    <div class="card-body"><div class="subject-tag tag-chemistry">CHEMISTRY</div><h3>Chemical Bonding & Molecular Structure</h3><p>VSEPR theory, hybridisation and bond polarity with MCQs.</p></div>
  </div>
  <div class="lecture-card" data-subject="maths" onclick="openPlayer('Integrals','‚à´','maths-bg')">
    <div class="thumb maths-bg">‚à´<div class="live-dot">LIVE</div><div class="viewer-count">üëÅ 3,102</div></div>
    <div class="card-body"><div class="subject-tag tag-maths">MATHEMATICS</div><h3>Integrals ‚Äì Definite & Indefinite</h3><p>Substitution, integration by parts, area under curves.</p></div>
  </div>
  <div class="lecture-card" data-subject="physics" onclick="openPlayer('Ray Optics','üî≠','physics-bg')">
    <div class="thumb physics-bg">üî≠<div class="viewer-count">üëÅ 987</div></div>
    <div class="card-body"><div class="subject-tag tag-physics">PHYSICS</div><h3>Ray Optics & Optical Instruments</h3><p>Mirror formula, refraction, lenses and human eye.</p></div>
  </div>
  <div class="lecture-card" data-subject="chemistry" onclick="openPlayer('Electrochemistry','‚öóÔ∏è','chemistry-bg')">
    <div class="thumb chemistry-bg">‚öóÔ∏è<div class="viewer-count">üëÅ 1,204</div></div>
    <div class="card-body"><div class="subject-tag tag-chemistry">CHEMISTRY</div><h3>Electrochemistry ‚Äì Full Chapter</h3><p>Galvanic cells, Nernst equation, Faraday's laws.</p></div>
  </div>
  <div class="lecture-card" data-subject="maths" onclick="openPlayer('Probability','üìä','maths-bg')">
    <div class="thumb maths-bg">üìä<div class="viewer-count">üëÅ 756</div></div>
    <div class="card-body"><div class="subject-tag tag-maths">MATHEMATICS</div><h3>Probability & Statistics</h3><p>Bayes theorem, mean/variance of distributions.</p></div>
  </div>
</div>
<nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="bnav-item active" onclick="activateNav(this)"><span>üè†</span>Home</button>
    <button class="bnav-item" onclick="activateNav(this)"><span>üìÖ</span>Schedule</button>
    <button class="bnav-item" onclick="activateNav(this)"><span>üìù</span>Notes</button>
    <button class="bnav-item" onclick="activateNav(this)"><span>‚úèÔ∏è</span>Tests</button>
  </div>
</nav>
<div class="modal" id="playerModal" onclick="closePlayer()">
  <div class="player" onclick="event.stopPropagation()">
    <div class="drag-handle"></div>
    <div class="player-screen" id="playerScreen">
      <span id="playerEmoji">‚ö°</span>
      <p>Live stream buffering‚Ä¶</p>
      <div class="progress-bar"><div class="progress-fill"></div></div>
    </div>
    <div class="player-info">
      <h2 id="playerTitle">Lecture</h2>
      <button class="close-btn" onclick="closePlayer()">‚úï Close</button>
    </div>
  </div>
</div>

<div id="vibruchu-panel">
  <button class="v-back" onclick="closeVibruchu()">‚Üê Back</button>
  <div class="v-logo">Vibruchu üíó</div>
  <div class="v-sub">live vibration sync</div>

  <!-- status bar -->
  <div class="v-status-bar" id="step-status" style="display:none;">
    <div id="v-dot"></div>
    <span id="v-status">Connecting‚Ä¶</span>
  </div>

  <!-- role picker -->
  <div class="v-role-card" id="step-role">
    <p>Who are you right now?</p>
    <div class="v-role-btns">
      <button class="v-btn" onclick="setRole('sender')">üì≥ Sender</button>
      <button class="v-btn" onclick="setRole('receiver')">üì± Receiver</button>
    </div>
  </div>

  <!-- role tag shown after pairing -->
  <div id="roleTag" style="display:none;"></div>

  <!-- sender hold button -->
  <button id="vibrateBtn"><span class="btn-icon">üíó</span>HOLD ME</button>

  <!-- sender controls -->
  <div class="v-controls" id="senderControls" style="display:none;">
    <!-- buzz slider -->
    <div class="v-ctrl-row">
      <div class="v-ctrl-label">Buzz duration <span id="buzzVal">200ms</span></div>
      <input type="range" id="buzzSlider" min="50" max="800" value="200" oninput="updateSlider(this,'buzzVal','ms')">
    </div>
    <!-- pause slider -->
    <div class="v-ctrl-row">
      <div class="v-ctrl-label">Pause duration <span id="pauseVal">100ms</span></div>
      <input type="range" id="pauseSlider" min="30" max="600" value="100" oninput="updateSlider(this,'pauseVal','ms')">
    </div>
    <!-- continuous toggle + wave -->
    <div class="v-action-row">
      <label class="v-toggle-wrap">
        <div class="v-toggle">
          <input type="checkbox" id="continuousToggle" onchange="toggleContinuous()">
          <div class="v-toggle-track"></div>
          <div class="v-toggle-thumb"></div>
        </div>
        Continuous
      </label>
      <button class="v-wave-btn" onclick="sendWave()" title="Send wave">üëã</button>
    </div>
  </div>

  <!-- receiver waiting -->
  <div class="v-receiver-waiting" id="receiverWaiting">
    <div class="heartbeat">üíó</div>
    <p>Waiting for a squeeze‚Ä¶</p>
  </div>

  <!-- receiver wave button -->
  <div class="v-controls" id="receiverControls" style="display:none;">
    <div class="v-action-row" style="justify-content:center;">
      <button class="v-wave-btn" onclick="sendWave()" title="Send wave" style="width:auto;padding:0 20px;font-size:16px;gap:8px;display:flex;">üëã Wave back</button>
    </div>
  </div>

  <div id="logBox"></div>
</div>

<!-- wave toast -->
<div id="waveToast">üëã</div>
<div id="waveFrom"></div>
<script>
function filterCards(subject,btn){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.lecture-card').forEach(c=>{c.style.display=(subject==='all'||c.dataset.subject===subject)?'':'none';});}
function openPlayer(title,emoji,bg){document.getElementById('playerTitle').innerText=title;document.getElementById('playerEmoji').innerText=emoji;document.getElementById('playerScreen').className='player-screen '+bg;document.getElementById('playerModal').classList.add('open');document.body.style.overflow='hidden';}
function closePlayer(){document.getElementById('playerModal').classList.remove('open');document.body.style.overflow='';}
function activateNav(btn){document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}

// SECRET ‚Äî tap LIVE badge 5 times within 3 seconds
let cc=0,ct;
document.querySelector('.live-badge').addEventListener('click',()=>{
  cc++;clearTimeout(ct);
  ct=setTimeout(()=>cc=0,3000);
  if(cc>=5){cc=0;openVibruchu();}
});

function openVibruchu(){document.getElementById('vibruchu-panel').classList.add('open');document.body.style.overflow='hidden';}
function closeVibruchu(){
  stopContinuous();
  if(ws){ws.close();ws=null;}
  role=null;isHolding=false;
  document.getElementById('step-role').style.display='';
  document.getElementById('step-status').style.display='none';
  document.getElementById('vibrateBtn').style.display='none';
  document.getElementById('vibrateBtn').classList.remove('ready');
  document.getElementById('receiverWaiting').classList.remove('show');
  document.getElementById('senderControls').style.display='none';
  document.getElementById('receiverControls').style.display='none';
  document.getElementById('roleTag').style.display='none';
  document.getElementById('continuousToggle').checked=false;
  document.getElementById('logBox').innerHTML='';
  setDot('');
  document.getElementById('vibruchu-panel').classList.remove('open');
  document.body.style.overflow='';
}

// SLIDER LOGIC
function updateSlider(el,valId,unit){
  const v=parseInt(el.value);
  document.getElementById(valId).innerText=v+unit;
  const pct=((v-el.min)/(el.max-el.min)*100).toFixed(1);
  el.style.setProperty('--pct',pct+'%');
}
// init slider fills on load
window.addEventListener('load',()=>{
  ['buzzSlider','pauseSlider'].forEach(id=>{
    const el=document.getElementById(id);
    const pct=((el.value-el.min)/(el.max-el.min)*100).toFixed(1);
    el.style.setProperty('--pct',pct+'%');
  });
});

function getBuzz(){return parseInt(document.getElementById('buzzSlider').value);}
function getPause(){return parseInt(document.getElementById('pauseSlider').value);}

// CONTINUOUS VIBRATION
let continuousInterval=null;
function toggleContinuous(){
  const on=document.getElementById('continuousToggle').checked;
  if(on){ startContinuous(); }
  else { stopContinuous(); }
}
function startContinuous(){
  if(continuousInterval) return;
  const fire=()=>{
    if(!ws||ws.readyState!==WebSocket.OPEN) return;
    const b=getBuzz(),p=getPause();
    if(navigator.vibrate) navigator.vibrate([b,p]);
    ws.send(JSON.stringify({type:'vibrate',pattern:[b,p]}));
  };
  fire();
  continuousInterval=setInterval(fire, getBuzz()+getPause()+10);
}
function stopContinuous(){
  if(continuousInterval){clearInterval(continuousInterval);continuousInterval=null;}
  if(navigator.vibrate) navigator.vibrate(0);
  if(ws&&ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'vibrate',pattern:[0]}));
}

// WAVE
function sendWave(){
  if(!ws||ws.readyState!==WebSocket.OPEN) return;
  ws.send(JSON.stringify({type:'wave',from:role}));
  if(navigator.vibrate) navigator.vibrate([60,40,60]);
}
function showWaveToast(from){
  const toast=document.getElementById('waveToast');
  const label=document.getElementById('waveFrom');
  const tag=from==='sender'?'üì≥ Sender waved!':'üì± Receiver waved!';
  label.innerText=tag;
  toast.className='show'; label.className='show';
  if(navigator.vibrate) navigator.vibrate([60,40,60]);
  setTimeout(()=>{toast.className='hide';label.className='';},1800);
}

// VIBRUCHU CORE
const SIGNAL_SERVER="wss://vibr-p581.onrender.com";
let ws=null,role=null,isHolding=false;

function log(msg){const b=document.getElementById('logBox');b.innerHTML+='‚Ä¢ '+msg+'<br>';b.scrollTop=b.scrollHeight;}
function setStatus(msg){document.getElementById('v-status').innerText=msg;log(msg);}
function setDot(state){document.getElementById('v-dot').className=state;}

function setRole(r){
  role=r;
  document.getElementById('step-role').style.display='none';
  document.getElementById('step-status').style.display='flex';
  setDot('waiting');setStatus('Connecting‚Ä¶');
  connect();
}

function connect(){
  try{ws=new WebSocket(SIGNAL_SERVER);}catch(e){setStatus('WebSocket failed');setDot('error');return;}
  ws.onopen=()=>{
    log('Connected ‚Äî registering as '+role);
    ws.send(JSON.stringify({type:'register',role}));
    setStatus('Registered. Waiting for peer‚Ä¶');
    setDot('waiting');
  };
  ws.onerror=()=>{setStatus('Cannot reach server');setDot('error');};
  ws.onclose=()=>{setStatus('Disconnected');setDot('error');document.getElementById('vibrateBtn').classList.remove('ready');stopContinuous();};
  ws.onmessage=(msg)=>{
    let data;try{data=JSON.parse(msg.data);}catch(e){return;}
    log('‚Üê '+data.type);

    if(data.type==='registered'){
      setStatus('Waiting for '+(role==='sender'?'receiver':'sender')+'‚Ä¶');
    }
    if(data.type==='paired'){
      setDot('connected');
      // show role tag
      const tag=document.getElementById('roleTag');
      tag.innerHTML='<span class="v-role-tag">'+(role==='sender'?'üì≥ You are Sender':'üì± You are Receiver')+'</span>';
      tag.style.display='block';

      if(role==='sender'){
        setStatus('Paired! Hold the button üíó');
        const btn=document.getElementById('vibrateBtn');
        btn.style.display='flex';
        btn.classList.add('ready');
        document.getElementById('senderControls').style.display='flex';
      } else {
        setStatus('Paired! Waiting for a squeeze‚Ä¶');
        document.getElementById('receiverWaiting').classList.add('show');
        document.getElementById('receiverControls').style.display='flex';
      }
    }
    if(data.type==='vibrate'){
      if(!navigator.vibrate){log('Vibration not supported');return;}
      navigator.vibrate(data.pattern||[200,100]);
    }
    if(data.type==='wave'){
      showWaveToast(data.from);
    }
    if(data.type==='peer_left'){
      setDot('waiting');setStatus('Peer disconnected‚Ä¶');
      document.getElementById('vibrateBtn').classList.remove('ready');
      document.getElementById('receiverWaiting').classList.remove('show');
      document.getElementById('senderControls').style.display='none';
      document.getElementById('receiverControls').style.display='none';
      document.getElementById('roleTag').style.display='none';
      stopContinuous();
    }
  };
}

// HOLD BUTTON
const vBtn=document.getElementById('vibrateBtn');
function press(){
  if(isHolding||!ws||ws.readyState!==WebSocket.OPEN) return;
  // don't fight with continuous mode
  if(document.getElementById('continuousToggle').checked) return;
  isHolding=true;
  const b=getBuzz(),p=getPause();
  if(navigator.vibrate) navigator.vibrate([b,p]);
  ws.send(JSON.stringify({type:'vibrate',pattern:[b,p]}));
}
function release(){
  if(!isHolding) return;
  isHolding=false;
  if(navigator.vibrate) navigator.vibrate(0);
  if(ws&&ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'vibrate',pattern:[0]}));
}
vBtn.addEventListener('mousedown',press);
vBtn.addEventListener('mouseup',release);
vBtn.addEventListener('mouseleave',release);
vBtn.addEventListener('touchstart',(e)=>{e.preventDefault();press();},{passive:false});
vBtn.addEventListener('touchend',(e)=>{e.preventDefault();release();},{passive:false});
vBtn.addEventListener('touchcancel',release);
</script>
</body>
</html>
